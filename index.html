<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Net-Cards - Networking through contact exchange">
    <meta name="theme-color" content="#00d1b2">
    <title>Net-Cards</title>

    <!-- Bulma CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">

    <style>
        .section-content {
            display: none;
        }
        .section-content.is-active {
            display: block;
        }
        #video-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        #qr-video {
            width: 100%;
            border-radius: 6px;
        }
        #qr-canvas {
            display: none;
        }
        .contact-card {
            margin-bottom: 1rem;
        }
        #qr-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
        }
        #qrcode {
            display: inline-block;
            text-align: center;
            margin: 0 auto;
        }
        #qrcode canvas {
            display: block;
            margin: 0 auto;
        }
        #qrcode img {
            display: none;
        }
        #contact-qr-display canvas {
            display: block;
            margin: 0 auto;
        }
        #contact-qr-display img {
            display: none;
        }
        .hero.is-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body>
    <!-- Simple Header -->
    <nav class="navbar is-primary" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="#">
                <strong>Net-Cards</strong>
            </a>
        </div>
    </nav>

    <!-- My Card Section -->
    <section id="my-card-section" class="section section-content is-active">
        <div class="container">
            <!-- QR Code Display - Primary -->
            <div class="box has-text-centered">
                <h2 class="title is-4">My QR Code</h2>
                <div id="qr-display">
                    <div id="qrcode"></div>
                    <div class="content" style="margin-top: 1rem;">
                        <p id="event-display" class="has-text-weight-bold"></p>
                    </div>
                </div>
                <div class="buttons is-centered" style="margin-top: 1.5rem;">
                    <button class="button is-large is-primary" id="quick-scan-btn">
                        <span class="icon is-large"><i class="fas fa-camera"></i></span>
                        <span>Scan QR Code</span>
                    </button>
                </div>
                <div class="buttons is-centered" style="margin-top: 0.5rem;">
                    <button class="button is-link" id="download-qr">
                        <span class="icon"><i class="fas fa-download"></i></span>
                        <span>Download QR</span>
                    </button>
                    <button class="button is-info" id="view-contacts-btn">
                        <span class="icon"><i class="fas fa-address-book"></i></span>
                        <span>View Contacts</span>
                    </button>
                    <button class="button is-warning" id="manage-tags-btn">
                        <span class="icon"><i class="fas fa-tags"></i></span>
                        <span>Manage Tags</span>
                    </button>
                </div>
            </div>

            <!-- Profile Editor - Collapsible -->
            <div class="box">
                <div class="level is-mobile" style="cursor: pointer;" id="toggle-profile-form">
                    <div class="level-left">
                        <div class="level-item">
                            <h2 class="subtitle is-5 mb-0">Edit Profile Information</h2>
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="level-item">
                            <span class="icon">
                                <i class="fas fa-chevron-down" id="profile-toggle-icon"></i>
                            </span>
                        </div>
                    </div>
                </div>
                <div id="profile-form-container" style="display: none; margin-top: 1rem;">
                    <form id="profile-form">
                            <div class="field">
                                <label class="label">Full Name *</label>
                                <div class="control">
                                    <input class="input" type="text" id="full-name" placeholder="John Doe" required>
                                </div>
                            </div>

                            <div class="field">
                                <label class="label">Email</label>
                                <div class="control">
                                    <input class="input" type="email" id="email" placeholder="john@example.com">
                                </div>
                            </div>

                            <div class="field">
                                <label class="label">Phone</label>
                                <div class="control">
                                    <input class="input" type="tel" id="phone" placeholder="+1234567890">
                                </div>
                            </div>

                            <div class="field">
                                <label class="label">Company</label>
                                <div class="control">
                                    <input class="input" type="text" id="company" placeholder="Acme Corp">
                                </div>
                            </div>

                            <div class="field">
                                <label class="label">Title</label>
                                <div class="control">
                                    <input class="input" type="text" id="title" placeholder="Software Engineer">
                                </div>
                            </div>

                            <div class="field">
                                <label class="label">Website</label>
                                <div class="control">
                                    <input class="input" type="url" id="website" placeholder="https://example.com">
                                </div>
                            </div>

                            <div class="field">
                                <label class="label">LinkedIn</label>
                                <div class="control">
                                    <input class="input" type="text" id="linkedin" placeholder="linkedin.com/in/johndoe">
                                </div>
                            </div>

                            <div class="field">
                                <label class="label">Twitter</label>
                                <div class="control">
                                    <input class="input" type="text" id="twitter" placeholder="@johndoe">
                                </div>
                            </div>

                            <div class="field">
                                <label class="label">GitHub</label>
                                <div class="control">
                                    <input class="input" type="text" id="github" placeholder="github.com/johndoe">
                                </div>
                            </div>

                            <div class="field">
                                <label class="label">Current Event</label>
                                <div class="control">
                                    <input class="input" type="text" id="current-event" placeholder="Tech Conference 2024">
                                </div>
                                <p class="help">This event will be embedded in your QR code</p>
                            </div>

                            <!-- QR Size Indicator -->
                            <div class="notification" id="qr-size-indicator" style="display: none; padding: 0.75rem 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="icon" id="qr-size-icon">
                                        <i class="fas fa-info-circle"></i>
                                    </span>
                                    <span id="qr-size-text"></span>
                                </div>
                            </div>

                            <div class="field">
                                <div class="control">
                                    <button class="button is-primary" type="submit">
                                        <span class="icon"><i class="fas fa-save"></i></span>
                                        <span>Save Profile</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Scan Section -->
    <section id="scan-section" class="section section-content">
        <div class="container">
            <h1 class="title">Scan QR Code</h1>

            <div class="columns">
                <div class="column is-half is-offset-one-quarter">
                    <div class="box">
                        <div class="field">
                            <label class="label">Default Event for Scanning</label>
                            <div class="control">
                                <input class="input" type="text" id="default-scan-event" placeholder="Tech Conference 2024">
                            </div>
                            <p class="help">Used if scanned card has no event tag</p>
                        </div>

                        <div id="video-container">
                            <video id="qr-video" autoplay playsinline></video>
                            <canvas id="qr-canvas"></canvas>
                        </div>

                        <div class="buttons is-centered" style="margin-top: 1rem;">
                            <button class="button is-primary" id="start-scan">
                                <span class="icon"><i class="fas fa-camera"></i></span>
                                <span>Start Camera</span>
                            </button>
                            <button class="button is-danger" id="stop-scan" style="display: none;">
                                <span class="icon"><i class="fas fa-stop"></i></span>
                                <span>Stop Camera</span>
                            </button>
                        </div>

                        <div id="scan-result" class="notification is-hidden" style="margin-top: 1rem;"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Contacts Section -->
    <section id="contacts-section" class="section section-content">
        <div class="container">
            <div class="level">
                <div class="level-left">
                    <div class="level-item">
                        <h1 class="title">My Contacts</h1>
                    </div>
                </div>
                <div class="level-right">
                    <div class="level-item">
                        <button class="button is-link" id="back-to-card-btn">
                            <span class="icon"><i class="fas fa-id-card"></i></span>
                            <span>My Card</span>
                        </button>
                    </div>
                    <div class="level-item">
                        <button class="button is-primary" id="add-contact-btn">
                            <span class="icon"><i class="fas fa-plus"></i></span>
                            <span>Add Contact</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="field has-addons">
                <div class="control is-expanded">
                    <input class="input" type="text" id="search-contacts" placeholder="Search contacts...">
                </div>
                <div class="control">
                    <button class="button is-info" id="search-btn">
                        <span class="icon"><i class="fas fa-search"></i></span>
                    </button>
                </div>
            </div>

            <div class="columns">
                <div class="column">
                    <div class="field">
                        <label class="label">Filter by Event</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select id="event-filter">
                                    <option value="">All Events</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div class="field">
                        <label class="label">Filter by Tag</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select id="tag-filter">
                                    <option value="">All Tags</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="contacts-list"></div>
        </div>
    </section>

    <!-- Tags Section -->
    <section id="tags-section" class="section section-content">
        <div class="container">
            <div class="level">
                <div class="level-left">
                    <div class="level-item">
                        <h1 class="title">Manage Tags</h1>
                    </div>
                </div>
                <div class="level-right">
                    <div class="level-item">
                        <button class="button is-link" id="back-to-card-from-tags-btn">
                            <span class="icon"><i class="fas fa-id-card"></i></span>
                            <span>My Card</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="box">
                <h2 class="subtitle">Add New Tag</h2>
                <div class="field has-addons">
                    <div class="control is-expanded">
                        <input class="input" type="text" id="new-tag-input" placeholder="Enter tag name (e.g., vendor, bitcoin, web3)">
                    </div>
                    <div class="control">
                        <button class="button is-primary" id="add-tag-btn">
                            <span class="icon"><i class="fas fa-plus"></i></span>
                            <span>Add Tag</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="box">
                <h2 class="subtitle">Existing Tags</h2>
                <div id="tags-list"></div>
            </div>
        </div>
    </section>

    <!-- Import/Export Section -->
    <section id="import-export-section" class="section section-content">
        <div class="container">
            <h1 class="title">Import/Export</h1>

            <div class="columns">
                <div class="column is-half">
                    <div class="box">
                        <h2 class="subtitle">Import Contacts</h2>
                        <div class="file has-name is-fullwidth">
                            <label class="file-label">
                                <input class="file-input" type="file" id="import-file" accept=".vcf,.vcard">
                                <span class="file-cta">
                                    <span class="file-icon">
                                        <i class="fas fa-upload"></i>
                                    </span>
                                    <span class="file-label">
                                        Choose VCF fileâ€¦
                                    </span>
                                </span>
                                <span class="file-name" id="import-filename">
                                    No file selected
                                </span>
                            </label>
                        </div>
                        <button class="button is-primary" id="import-btn" style="margin-top: 1rem;" disabled>
                            <span class="icon"><i class="fas fa-file-import"></i></span>
                            <span>Import</span>
                        </button>
                        <div id="import-result" class="notification is-hidden" style="margin-top: 1rem;"></div>
                    </div>
                </div>

                <div class="column is-half">
                    <div class="box">
                        <h2 class="subtitle">Export Contacts</h2>
                        <div class="content">
                            <p>Export all contacts as VCF file</p>
                        </div>
                        <button class="button is-link" id="export-all-btn">
                            <span class="icon"><i class="fas fa-file-export"></i></span>
                            <span>Export All Contacts</span>
                        </button>

                        <hr>

                        <div class="content">
                            <p>Export by event:</p>
                        </div>
                        <div class="field has-addons">
                            <div class="control is-expanded">
                                <div class="select is-fullwidth">
                                    <select id="export-event-filter">
                                        <option value="">Select Event</option>
                                    </select>
                                </div>
                            </div>
                            <div class="control">
                                <button class="button is-link" id="export-event-btn">
                                    <span class="icon"><i class="fas fa-download"></i></span>
                                    <span>Export</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Loading notification -->
    <div id="loading" class="modal">
        <div class="modal-background"></div>
        <div class="modal-content">
            <div class="box has-text-centered">
                <p class="title is-4">Loading...</p>
                <progress class="progress is-primary" max="100"></progress>
            </div>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div id="add-contact-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Add Contact Manually</p>
                <button class="delete" aria-label="close" id="close-add-contact"></button>
            </header>
            <section class="modal-card-body">
                <form id="add-contact-form">
                    <div class="field">
                        <label class="label">Full Name *</label>
                        <div class="control">
                            <input class="input" type="text" id="add-name" required>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">Email</label>
                        <div class="control">
                            <input class="input" type="email" id="add-email">
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">Phone</label>
                        <div class="control">
                            <input class="input" type="tel" id="add-phone">
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">Company</label>
                        <div class="control">
                            <input class="input" type="text" id="add-company">
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">Title</label>
                        <div class="control">
                            <input class="input" type="text" id="add-title">
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">Website</label>
                        <div class="control">
                            <input class="input" type="url" id="add-website">
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">LinkedIn</label>
                        <div class="control">
                            <input class="input" type="text" id="add-linkedin">
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">Twitter</label>
                        <div class="control">
                            <input class="input" type="text" id="add-twitter">
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">GitHub</label>
                        <div class="control">
                            <input class="input" type="text" id="add-github">
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">Event</label>
                        <div class="control">
                            <input class="input" type="text" id="add-event">
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">Tags</label>
                        <div id="add-contact-tags" class="control">
                            <!-- Tag checkboxes will be inserted here -->
                        </div>
                    </div>
                </form>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-primary" id="save-new-contact">Save Contact</button>
                <button class="button" id="cancel-add-contact">Cancel</button>
            </footer>
        </div>
    </div>

    <!-- View Contact QR Modal -->
    <div id="view-qr-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title" id="qr-modal-title">Contact QR Code</p>
                <button class="delete" aria-label="close" id="close-qr-modal"></button>
            </header>
            <section class="modal-card-body has-text-centered">
                <div id="contact-qr-display"></div>
                <div class="content" style="margin-top: 1rem;">
                    <p id="qr-contact-info"></p>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-primary" id="download-contact-qr">
                    <span class="icon"><i class="fas fa-download"></i></span>
                    <span>Download QR Code</span>
                </button>
                <button class="button" id="close-qr-modal-btn">Close</button>
            </footer>
        </div>
    </div>

    <!-- Scanned Contact Preview Modal -->
    <div id="scanned-contact-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Contact Scanned</p>
                <button class="delete" aria-label="close" id="close-scanned-contact"></button>
            </header>
            <section class="modal-card-body">
                <div class="content" id="scanned-contact-details">
                    <!-- Contact details will be inserted here -->
                </div>
                <div class="field">
                    <label class="label">Tags</label>
                    <div id="scanned-contact-tags" class="control">
                        <!-- Tag checkboxes will be inserted here -->
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" id="save-scanned-contact">
                    <span class="icon"><i class="fas fa-save"></i></span>
                    <span>Save to Contacts</span>
                </button>
                <button class="button" id="cancel-scanned-contact">Cancel</button>
            </footer>
        </div>
    </div>

    <!-- Quick Scan Modal (Camera) -->
    <div id="quick-scan-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Scan QR Code</p>
                <button class="delete" aria-label="close" id="close-quick-scan"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">Default Event for Scanned Contacts</label>
                    <div class="control">
                        <input class="input" type="text" id="quick-scan-event" placeholder="Tech Conference 2024">
                    </div>
                    <p class="help">Used if scanned card has no event tag</p>
                </div>

                <div id="quick-video-container" style="max-width: 500px; margin: 1rem auto;">
                    <video id="quick-qr-video" autoplay playsinline style="width: 100%; border-radius: 6px;"></video>
                    <canvas id="quick-qr-canvas" style="display: none;"></canvas>
                </div>

                <div id="quick-scan-result" class="notification is-hidden" style="margin-top: 1rem;"></div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-danger" id="stop-quick-scan">
                    <span class="icon"><i class="fas fa-stop"></i></span>
                    <span>Stop Camera</span>
                </button>
            </footer>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <script src="js/db.js"></script>
    <script src="js/vcard.js"></script>
    <script src="js/qr-generator.js"></script>
    <script src="js/qr-scanner.js"></script>
    <script src="js/contacts.js"></script>
    <script src="js/tags.js"></script>
    <script src="js/import-export.js"></script>
    <script src="js/app.js"></script>

    <script>
        // Register service worker with update handling
        if ('serviceWorker' in navigator) {
            let refreshing = false;

            // Reload page when new service worker takes over
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    window.location.reload();
                }
            });

            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration);

                        // Check for updates every 60 seconds
                        setInterval(() => {
                            registration.update();
                        }, 60000);

                        // Handle waiting service worker (update available)
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New update available
                                    if (confirm('New version available! Reload to update?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                    }
                                }
                            });
                        });
                    })
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>
</body>
</html>
